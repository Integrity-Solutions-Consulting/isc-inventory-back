package com.isc.service.impl;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.isc.dto.request.EquipmentRepairRequestDTO;
import com.isc.dto.response.EquipmentRepairDetailResponseDTO;
import com.isc.dto.response.EquipmentRepairResponseDTO;
import com.isc.dto.response.MessageResponseDTO;
import com.isc.dtos.MetadataResponseDto;
import com.isc.dtos.ResponseDto;
import com.isc.entitys.EquipmentEntity;
import com.isc.entitys.EquipmentRepairEntity;
import com.isc.entitys.EquipmentStatusEntity;
import com.isc.mapper.EquipmentCharacteristicMapper;
import com.isc.mapper.EquipmentRepairMapper;
import com.isc.repository.EquipmentRepairRepository;
import com.isc.repository.EquipmentRepository;
import com.isc.repository.EquipmentStatusRepository;
import com.isc.service.EquipmentRepairService;
import org.springframework.http.HttpStatus;

@Service
public class EquipmentRepairServiceImpl implements EquipmentRepairService {

    private EquipmentRepairRepository repairRepository;
    private EquipmentRepository equipmentRepository;
    private EquipmentStatusRepository statusRepository;

    @Override
    public ResponseDto<List<EquipmentRepairDetailResponseDTO>> getAllDetails() {
        List<EquipmentRepairDetailResponseDTO> response = repairRepository.findAll().stream()
                .map(repair -> {
                    EquipmentRepairDetailResponseDTO dto = EquipmentRepairMapper.toDetailDto(repair);
                    dto.setSerialNumber(repair.getEquipment().getSerialNumber());
                    return dto;
                })
                .collect(Collectors.toList());
        
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Reparaciones listadas correctamente");
        return new ResponseDto<>(response, metadata);
     }

    @Override
    public ResponseDto<List<EquipmentRepairResponseDTO>> getSimpleList() {
        List<EquipmentRepairResponseDTO> response = repairRepository.findAll().stream()
                .map(EquipmentRepairMapper::toSimpleDto)
                .collect(Collectors.toList());
        
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Reparaciones listadas correctamente");
        return new ResponseDto<>(response, metadata);
    }
    
    @Override
    public ResponseDto<EquipmentRepairDetailResponseDTO> save(EquipmentRepairRequestDTO request) {
        EquipmentEntity equipment = equipmentRepository.findById(request.getEquipment())
            .orElseThrow(() -> new RuntimeException("Equipo no encontrado con ID: " + request.getEquipment()));

        //Buscar o crear el estado "EN_REPARACIÓN"
        EquipmentStatusEntity repairStatus = statusRepository.findByName("EN_REPARACION")
            .orElseGet(() -> {
                EquipmentStatusEntity newStatus = new EquipmentStatusEntity();
                newStatus.setName("EN_REPARACION");
                newStatus.setStatus(true);
                newStatus.setCreationDate(LocalDateTime.now());
                return statusRepository.save(newStatus);
            });

        equipment.setEquipStatus(repairStatus);
        equipment.setModificationDate(LocalDateTime.now());
        equipmentRepository.save(equipment);

        EquipmentRepairEntity repair = EquipmentRepairMapper.toEntity(request, equipment);
        repair.setCreationDate(LocalDateTime.now());
        repair.setStatus(true);
        EquipmentRepairEntity savedRepair = repairRepository.save(repair);

        EquipmentRepairDetailResponseDTO responseDTO = EquipmentRepairMapper.toDetailDTO(savedRepair);

        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.CREATED,"Reparación registrada correctamente");
        return new ResponseDto<>(responseDTO, metadata);
    }   

    @Override
    public ResponseDto<EquipmentRepairDetailResponseDTO> update(EquipmentRepairRequestDTO request, Integer id) {
    	EquipmentRepairEntity repair = repairRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Reparación no encontrada con ID: " + id));
        EquipmentEntity equipment = equipmentRepository.findById(request.getEquipment())
                .orElseThrow(() -> new RuntimeException("Equipo no encontrado con ID: " + request.getEquipment()));

            // Actualizar los campos de la reparación
        repair.setRepairDate(request.getRepairDate());
        repair.setDescription(request.getDescription());
        repair.setCost(request.getCost());
        repair.setServiceProvider(request.getServiceProvider());
        repair.setModificationDate(LocalDateTime.now());
        repair.setEquipment(equipment);
        repair.setModificationUser(request.getModificationUser());

            EquipmentRepairEntity updatedRepair = repairRepository.save(existingRepair);

            EquipmentRepairDetailResponseDTO responseDTO = EquipmentRepairMapper.toDetailDto(updatedRepair);
            MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Reparación actualizada correctamente");
            return new ResponseDto<>(responseDTO, metadata);
    }

    @Override
    public ResponseDto<MessageResponseDTO> inactive(Integer id) {
    	int rowsAffected = repairRepository.inactive(id);
        if (rowsAffected == 0) {
            throw new RuntimeException("No se pudo inactivar la característica con ID: " + id);
        }
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Característica inactivada correctamente");
        return new ResponseDto<>(new MessageResponseDTO("Operación exitosa"), metadata);
    }

    @Override
    public ResponseDto<MessageResponseDTO> active(Integer id) {
    	int rowsAffected = repairRepository.active(id);
        if (rowsAffected == 0) {
            throw new RuntimeException("No se pudo activar la característica con ID: " + id);
        }
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Característica activada correctamente");
        return new ResponseDto<>(new MessageResponseDTO("Operación exitosa"), metadata);
    }
}
