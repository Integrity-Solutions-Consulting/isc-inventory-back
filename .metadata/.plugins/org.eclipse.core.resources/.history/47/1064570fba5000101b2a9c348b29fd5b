package com.isc.service.impl;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

import com.isc.dto.request.InvoiceRequestDTO;
import com.isc.dto.response.InvoiceDetailResponseDTO;
import com.isc.dto.response.InvoiceResponseDTO;
import com.isc.dto.response.MessageResponseDTO;
import com.isc.dtos.MetadataResponseDto;
import com.isc.dtos.ResponseDto;
import com.isc.entitys.EquipmentCategoryEntity;
import com.isc.entitys.InvoiceDetailEntity;
import com.isc.entitys.InvoiceEntity;
import com.isc.entitys.SupplierEntity;
import com.isc.mapper.InvoiceMapper;
import com.isc.repository.EquipmentCategoryRepository;
import com.isc.repository.InvoiceDetailRepository;
import com.isc.repository.InvoiceRepository;
import com.isc.repository.SupplierRepository;
import com.isc.service.InvoiceService;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class InvoiceServiceImpl implements InvoiceService {

    private final InvoiceRepository invoiceRepository;
    private final InvoiceDetailRepository invoiceDetailRepository;
    private final SupplierRepository supplierRepository;
    private final EquipmentCategoryRepository categoryRepository;

    @Override
    public ResponseDto<List<InvoiceDetailResponseDTO>> getAllDetails() {
        List<InvoiceDetailResponseDTO> response = invoiceRepository.findAll().stream()
                .map(InvoiceMapper::toInvoiceDetailDto)
                .collect(Collectors.toList());
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Facturas listadas correctamente");
        return new ResponseDto<>(response, metadata);
    }

    @Override
    public ResponseDto<List<InvoiceResponseDTO>> getSimpleList() {
        List<InvoiceResponseDTO> response = invoiceRepository.findAllByStatusTrue().stream()
                .map(InvoiceMapper::toInvoiceDto)
                .collect(Collectors.toList());
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Facturas activas listadas correctamente");
        return new ResponseDto<>(response, metadata);
    }

    @Override
    public ResponseDto<InvoiceDetailResponseDTO> save(InvoiceRequestDTO request) {
        InvoiceDetailEntity detail = new InvoiceDetailEntity();
        EquipmentCategoryEntity category = categoryRepository.findById(request.getInvoiceDetailRequest().getCategory())
        		.orElseThrow(() -> new RuntimeException("Categoria no encontrada"));
        
     // Datos base
        BigDecimal unitPrice = request.getInvoiceDetailRequest().getUnitPrice();
        Integer quantity = request.getInvoiceDetailRequest().getQuantity();
        BigDecimal discount = request.getInvoiceDetailRequest().getDiscount() != null
                ? request.getInvoiceDetailRequest().getDiscount()
                : BigDecimal.ZERO;

        // Calcular subtotal = unitPrice * quantity
        BigDecimal subtotal = unitPrice.multiply(BigDecimal.valueOf(quantity));

        // Calcular impuesto (ejemplo 15%)
        BigDecimal taxRate = new BigDecimal("0.15");
        BigDecimal tax = subtotal.multiply(taxRate);

        // Calcular total = subtotal + tax - discount
        BigDecimal total = subtotal.add(tax).subtract(discount);
        
        detail.setDescription(request.getInvoiceDetailRequest().getDescription());
        detail.setQuantity(quantity);
        detail.setUnitPrice(unitPrice);
        detail.setDiscount(discount);
        detail.setSubtotal(subtotal);
        detail.setTax(tax);
        detail.setTotal(total);
        detail.setCategory(category);
        
        
        SupplierEntity supplier = supplierRepository.findById(request.getSupplier())
                .orElseThrow(() -> new RuntimeException("Proveedor no encontrado"));

        InvoiceEntity entity = new InvoiceEntity();
        entity.setInvoiceDetail(detail);
        entity.setSupplier(supplier);
        entity.setInvoiceDate(request.getInvoiceDate());
        entity.setInvoiceNumber(request.getInvoiceNumber());

        entity = invoiceRepository.save(entity);
        InvoiceDetailResponseDTO response = InvoiceMapper.toInvoiceDetailDto(entity);
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Factura registrada correctamente");
        return new ResponseDto<>(response, metadata);
    }

    @Override
    public ResponseDto<InvoiceDetailResponseDTO> update(InvoiceRequestDTO request, Integer id) {
        InvoiceEntity entity = invoiceRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Factura no encontrada"));

        if (!entity.getInvoiceDetail().getId().equals(request.getInvoiceDetailRequest())) {
            InvoiceDetailEntity detail = invoiceDetailRepository.findById(request.getInvoiceDetailRequest())
                    .orElseThrow(() -> new RuntimeException("Detalle de factura no encontrado"));
            entity.setInvoiceDetail(detail);
        }

        if (!entity.getSupplier().getId().equals(request.getSupplier())) {
            SupplierEntity supplier = supplierRepository.findById(request.getSupplier())
                    .orElseThrow(() -> new RuntimeException("Proveedor no encontrado"));
            entity.setSupplier(supplier);
        }

        entity.setInvoiceDate(request.getInvoiceDate());
        entity.setInvoiceNumber(request.getInvoiceNumber());

        entity = invoiceRepository.save(entity);
        InvoiceDetailResponseDTO response = InvoiceMapper.toInvoiceDetailDto(entity);
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Factura actualizada correctamente");
        return new ResponseDto<>(response, metadata);
    }

    @Override
    public ResponseDto<MessageResponseDTO> inactive(Integer id) {
        int rowsAffected = invoiceRepository.inactive(id);
        if (rowsAffected == 0) {
            throw new RuntimeException("No se pudo inactivar la factura con ID: " + id);
        }
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Factura inactivada correctamente");
        return new ResponseDto<>(new MessageResponseDTO("Operación exitosa"), metadata);
    }

    @Override
    public ResponseDto<MessageResponseDTO> active(Integer id) {
        int rowsAffected = invoiceRepository.active(id);
        if (rowsAffected == 0) {
            throw new RuntimeException("No se pudo activar la factura con ID: " + id);
        }
        MetadataResponseDto metadata = new MetadataResponseDto(HttpStatus.OK, "Factura activada correctamente");
        return new ResponseDto<>(new MessageResponseDTO("Operación exitosa"), metadata);
    }
}
